/**
 * Created by MrLutin on 2017-12-22.
 */

$('a.accepte').on('click',function(e){
    e.preventDefault();
    var title = 'Êtes vous certain d\'accepter ce membre?';
    var text = 'Il pourrais ne pas respecter les rêglements du serveur.';
    var type = 'warning';
    var url = "/api/whitelist/accepte";
    var data = {
        member : $(this).attr('data-user'),
        validationBy : $(this).attr('data-validateBy'),
        token : $("meta[name=csrf-token]").attr("content")
    };
    postAlertModal(title, text, type, url, data)
});

$('a.refuse').on('click',function(e){
    e.preventDefault();
    var title = 'Êtes vous certain de refuser?';
    var text = 'Ce membre deveras refaire une candidature';
    var type = 'warning';
    var url = "/api/whitelist/refuse";
    var data = {
        member : $(this).attr('data-user'),
        validationBy : $(this).attr('data-validateBy'),
        token : $("meta[name=csrf-token]").attr("content")
    };
    postAlertModal(title, text, type, url, data)
});

$('a.delete').on('click',function(e){
    e.preventDefault();
    var title = 'Êtes vous certain de supprimer ce commentaire?';
    var text = '';
    var type = 'warning';
    var url = "/api/comment/delete";
    var data = {
        comment : $(this).attr('data-comment'),
        token : $("meta[name=csrf-token]").attr("content")
    };
    postAlertModal(title, text, type, url, data)
});

$('a.edit').on('click',function(e){
    e.preventDefault();

    $('.modal-body').load($(this).attr('data-comment-url'),function(){
        $('#Modal').modal({show:true});
    });
});


$('#whitelist').on('click',function(e){
    e.preventDefault();
    var title = 'Êtes vous certain?';
    var text = '';
    var type = 'warning';
    var url = "/api/whitelist/activate";
    var data = {
        whitelisted : $(this).attr('data-value'),
        //token : $("meta[name=csrf-token]").attr("content")
    };
    postAlertModal(title, text, type, url, data)
});

$('#webhook').on('click',function(e){
    e.preventDefault();
    var title = 'Êtes vous certain?';
    var text = '';
    var type = 'warning';
    var url = "/api/webhook/activate";
    var data = {
        webhook_activated : $(this).attr('data-value'),
        token : $("meta[name=csrf-token]").attr("content")
    };
    postAlertModal(title, text, type, url, data)
});

function postAlertModal(title, text, type, url, data){

    swal({
        title: title,
        text: text,
        type: type,
        confirmButtonClass: 'btn btn-success',
        cancelButtonClass: 'btn btn-light',
        showCancelButton: true,
        allowOutsideClick: false,
        confirmButtonText: 'Oui',
        cancelButtonText: 'Annuler'
    }).then((result) => {
        if (result.value) {
        $.ajax({
            type: "POST",
            url: url,
            data: data,
            success: function(request){
                var req = $.parseJSON(request);
                swal({
                    title: req.title,
                    text: req.text,
                    type: 'success',
                    confirmButtonText: 'close',
                    confirmButtonClass: 'btn btn-light',
                    showLoaderOnConfirm: true,
                    allowOutsideClick: false,
                    preConfirm: function(){ setTimeout(document.location.reload(true),5000) }

                });
            },
            error: function(XMLHttpRequest, textStatus, errorThrown) {
                apiError(XMLHttpRequest, textStatus, errorThrown);
            }
        });

    } else if (result.dismiss === 'cancel') {
        swal(
            '',
            'Aucun changement effectué',
            'error',
            'Fermer',
        )
    }
})

}

function apiError(xhr, status, error){
    swal({
        title: 'Oupss, ['+ error +']',
        text: "L'api n'as pas répondu a la requête",
        type: 'error',
        buttonsStyling: false,
        confirmButtonText: 'close',
        confirmButtonClass: 'btn btn-primary',
    });
}